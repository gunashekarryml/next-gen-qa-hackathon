name: Playwright CI + Traige + Dashboard

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  setup:
    name: Setup Node.js and Dependencies
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20
          cache: "npm"

      - name: Install Root Dependencies
        run: npm install

      - name: Install Playwright Browsers
        run: npx playwright install

  enrich-triage-test:
    name: Enrich, Triage, Validate, Generate Reports
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Install Dependencies
        run: npm install

      - name: Enrich JSONL Test Data
        run: npm run enrich

      - name: Run Triage & Playwright Tests
        run: npm run ci

      - name: Generate Allure Report
        run: npm run allure

      - name: Upload Allure Report Artifact
        uses: actions/upload-artifact@v3
        with:
          name: allure-report
          path: playwright-tests/allure-report

  deploy-dashboard:
    name: Build and Deploy Triage Dashboard
    runs-on: ubuntu-latest
    needs: enrich-triage-test
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Install triage-dashboard dependencies
        run: |
          cd triage-dashboard
          npm install

      - name: Copy Enriched JSON to Dashboard
        run: cp ./playwright-tests/test-data/TestData.enriched.jsonl ./triage-dashboard/public/TestData.enriched.jsonl

      - name: Build React Dashboard
        run: |
          cd triage-dashboard
          npm run build

      - name: Deploy Dashboard to GitHub Pages
        uses: peaceiris/actions-gh-pages@v5
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: triage-dashboard/build
          user_name: "github-actions[bot]"
          user_email: "github-actions[bot]@users.noreply.github.com"
