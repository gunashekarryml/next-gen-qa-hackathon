name: Playwright Triage Dashboard

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  test-and-report:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install dependencies
        run: npm install

      - name: Run Playwright Tests
        run: npx playwright test --reporter=line

      # CLEAN PAST REPORTS BEFORE GENERATING FRESH ONE
      - name: Remove old Allure Reports
        run: |
          rm -rf allure-report
          rm -rf allure-results/allure-report

      - name: Generate Allure Report
        run: |
          npx allure generate allure-results --clean -o allure-report
          cp -r allure-report ./public-allure

      - name: Upload Allure Report Artifact
        uses: actions/upload-artifact@v4
        with:
          name: allure-report
          path: public-allure

      # âœ… Deploy Dashboard + Allure as static site bundle
      - name: Prepare Pages Bundle
        run: |
          mkdir -p public/dashboard
          cp -r dashboard/* public/dashboard/
          mkdir -p public/allure
          cp -r public-allure/* public/allure/

      - name: Deploy GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public

      # âœ… Wait to ensure GitHub Pages has the latest summary.json uploaded
      - name: Wait for Pages Sync
        run: sleep 10

      - name: Create Slack & Email Summary
        run: |
          node triage-dashboard/create-summary.js \
          --allureDir="public/allure" \
          --dashboardUrl="https://gunashekarryml.github.io/team2-qa-hackathon/dashboard/" \
          --allureUrl="https://gunashekarryml.github.io/team2-qa-hackathon/allure/"
        env:
          TEST_DATA_OUT: playwright-tests/test-data/TestData.enriched.jsonl
          SLACK_TOKEN: ${{ secrets.SLACK_TOKEN }}
          SLACK_CHANNEL: ${{ secrets.SLACK_CHANNEL }}
          EMAIL_USERNAME: ${{ secrets.EMAIL_USERNAME }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
          EMAIL_RECEPIENTS: ${{ secrets.EMAIL_RECEPIENTS }}

      - name: Send Email Notification
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "âœ… Dashboard & Allure Updated Successfully"
          from: ${{ secrets.EMAIL_USERNAME }}
          to: ${{ secrets.EMAIL_RECEPIENTS }}
          body: ðŸ“Š Deployment Done. Check Dashboard + Allure Report!
